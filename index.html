<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant Customs Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        body { background-color: #0a0a0c; color: #ffffff; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-user-select: none; user-select: none; overflow-x: hidden; }
        .glass { background: rgba(10, 10, 12, 0.7) !important; backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
        
        .aurora-container { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .aurora-glow { 
            position: absolute; top: -10%; right: -5%; width: 65vw; height: 65vw; 
            background: radial-gradient(circle, rgba(255, 70, 85, 0.18) 0%, rgba(147, 51, 234, 0.12) 50%, transparent 70%); 
            filter: blur(120px); border-radius: 50%; animation: auroraMove 15s infinite alternate ease-in-out;
        }
        @keyframes auroraMove { from { transform: translate(0,0); } to { transform: translate(-10%, 5%); } }

        #announcement-bar { box-shadow: 0 0 25px rgba(255, 70, 85, 0.35); border: 1px solid rgba(255, 70, 85, 0.5); }

        tr { position: relative; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; }
        tr:hover { transform: scale(1.012); background: rgba(255, 255, 255, 0.05) !important; z-index: 10; }
        tr:hover::after {
            content: ""; position: absolute; top: 0; left: -150%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.15), transparent);
            transform: skewX(-25deg); animation: shimmer 0.8s ease-out forwards;
            pointer-events: none;
        }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }

        .rank-cell { text-align: center; width: 110px; vertical-align: middle; }
        .rank-crown { font-size: 3.8rem; filter: drop-shadow(0 0 15px rgba(250, 204, 21, 0.6)); }
        .rank-medal { font-size: 3rem; }
        .stat-glow { color: #facc15 !important; font-weight: 800; text-shadow: 0 0 12px rgba(250, 204, 21, 0.6); }
        .best-glow { color: #22d3ee !important; font-weight: 900; text-shadow: 0 0 15px rgba(34, 211, 238, 0.8); }

        .gold-row { background: linear-gradient(90deg, rgba(202, 138, 4, 0.12) 0%, transparent 100%) !important; border-left: 5px solid #eab308 !important; }
        td, th { vertical-align: middle; padding: 1.5rem; opacity: 1 !important; color: white; }
    </style>
</head>
<body class="p-6 md:p-12">
    <div id="loading-screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0a0a0c]">
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-4 border-[#ff4655] animate-ping opacity-20"></div>
            <div class="absolute inset-0 border-4 border-[#ff4655] rotate-45 animate-[spin_3s_linear_infinite]"></div>
            <div class="absolute inset-6 bg-[#ff4655] rotate-45 shadow-[0_0_30px_#ff4655]"></div>
        </div>
        <h2 class="text-2xl font-black italic tracking-[0.4em] uppercase text-white animate-pulse">Establishing Connection</h2>
    </div>

    <div class="aurora-container"><div class="aurora-glow"></div></div>

    <div id="main-content" class="max-w-[1750px] mx-auto opacity-0 transition-opacity duration-1000">
        <div id="announcement-bar" class="hidden mb-10 p-6 glass border-l-4 border-[#ff4655] rounded-xl">
            <div class="flex items-center gap-4">
                <div class="bg-[#ff4655] text-white text-[10px] font-black px-2 py-1 rounded animate-pulse">LIVE</div>
                <div><span id="ann-title" class="text-white font-bold uppercase text-2xl mr-2"></span><span id="ann-body" class="text-gray-300 italic text-xl"></span></div>
            </div>
        </div>

        <header class="mb-14 flex flex-col md:flex-row justify-between items-center gap-6">
            <h1 class="text-6xl font-black italic uppercase tracking-tighter">ChiouCITY <span class="text-[#ff4655]">Stats</span></h1>
            
            <div class="relative w-full max-w-md group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-gray-500 group-focus-within:text-[#ff4655] transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text" id="player-search" placeholder="SEARCH PLAYER..." oninput="handleSearch(this.value)"
                       class="w-full bg-white/5 border-2 border-white/10 rounded-xl py-4 pl-12 pr-4 text-sm font-black tracking-widest uppercase focus:outline-none focus:border-[#ff4655] focus:bg-white/10 transition-all placeholder:text-gray-600">
            </div>

            <nav class="glass flex p-1">
                <button onclick="switchTab('kd')" id="tab-kd" class="px-12 py-5 uppercase text-sm font-black tracking-widest transition-all bg-[#ff4655]/10 text-[#ff4655] border-b-2 border-[#ff4655]">KDR Rankings</button>
                <button onclick="switchTab('pqs')" id="tab-pqs" class="px-12 py-5 uppercase text-sm font-black tracking-widest transition-all text-gray-500">PQS</button>
            </nav>
        </header>

        <div class="glass overflow-hidden shadow-2xl">
            <table class="w-full text-left border-collapse">
                <thead id="table-head" class="bg-black/40"></thead>
                <tbody id="leaderboard-body" class="transition-opacity duration-300"></tbody>
            </table>
        </div>
    </div>

<script>
const API_KEY = 'AIzaSyBZ6oTJCJUSxCsz_3fbi7lNo-2OP4Y5IDk'; 
const SHEET_ID = '1ALv-N6o8GQ9qvcHR-xKPqaQYEXyqJsItkx2EheCcykc';
let activeTab = 'kd'; let masterData = []; let topStats = {}; let searchQuery = '';

async function init() {
    try {
        const [lbRes, annRes] = await Promise.all([
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/'Leaderboard'!A2:N100?key=${API_KEY}`),
            fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Announcements!A1:B1?key=${API_KEY}`)
        ]);
        const lbData = await lbRes.json(); const annData = await annRes.json();
        
        if (annData.values?.[0]) {
            document.getElementById('announcement-bar').classList.remove('hidden');
            document.getElementById('ann-title').innerText = annData.values[0][0];
            document.getElementById('ann-body').innerText = annData.values[0][1];
        }

        if (lbData.values) {
            masterData = lbData.values.filter(r => r[1]).map(r => ({
                rankId: r[0], name: r[1], kills: parseInt(r[2])||0, deaths: parseInt(r[3])||0,
                kd: parseFloat(r[4])||0, wins: parseInt(r[5])||0, losses: parseInt(r[6])||0, 
                wr: r[7]||'0%', gp: parseInt(r[8])||0, avgK: parseFloat(r[9])||0, 
                avgD: parseFloat(r[10])||0, highestK: parseInt(r[12])||0, pqs: parseFloat(r[13])||0 
            }));
            calculateTopStats(); renderTable(); hideLoader();
        }
    } catch (e) { console.error(e); }
}

function calculateTopStats() {
    const rankedPlayers = masterData.filter(p => !p.rankId?.toString().includes('?') || p.gp >= 5);
    topStats = {
        kills: Math.max(...rankedPlayers.map(p => p.kills)), deaths: Math.max(...rankedPlayers.map(p => p.deaths)),
        kd: Math.max(...rankedPlayers.map(p => p.kd)), wins: Math.max(...rankedPlayers.map(p => p.wins)), 
        losses: Math.max(...rankedPlayers.map(p => p.losses)), wr: Math.max(...rankedPlayers.map(p => parseFloat(p.wr.replace('%','')))),
        gp: Math.max(...rankedPlayers.map(p => p.gp)), avgK: Math.max(...rankedPlayers.map(p => p.avgK)),
        avgD: Math.max(...rankedPlayers.map(p => p.avgD)), highestK: Math.max(...rankedPlayers.map(p => p.highestK)), 
        pqs: Math.max(...rankedPlayers.map(p => p.pqs))
    };
}

function handleSearch(val) {
    searchQuery = val.toLowerCase().trim();
    renderTable();
}

function switchTab(tab) {
    activeTab = tab; searchQuery = ''; document.getElementById('player-search').value = '';
    const body = document.getElementById('leaderboard-body');
    body.style.opacity = '0';
    setTimeout(() => {
        document.getElementById('tab-kd').className = tab === 'kd' ? 'px-12 py-5 uppercase text-sm font-black tracking-widest transition-all bg-[#ff4655]/10 text-[#ff4655] border-b-2 border-[#ff4655]' : 'px-12 py-5 uppercase text-sm font-black tracking-widest transition-all text-gray-500 hover:text-white';
        document.getElementById('tab-pqs').className = tab === 'pqs' ? 'px-12 py-5 uppercase text-sm font-black tracking-widest transition-all bg-[#ff4655]/10 text-[#ff4655] border-b-2 border-[#ff4655]' : 'px-12 py-5 uppercase text-sm font-black tracking-widest transition-all text-gray-500 hover:text-white';
        renderTable(); body.style.opacity = '1';
    }, 150);
}

function renderTable() {
    const head = document.getElementById('table-head'); 
    const body = document.getElementById('leaderboard-body');
    
    head.innerHTML = activeTab === 'kd' ? 
        `<tr><th class="text-center">Rank</th><th>Player</th><th>Kills</th><th>Deaths</th><th class="text-center">KDR</th><th>Wins</th><th>Losses</th><th>WR%</th><th>GP</th><th>Avg K</th><th>Avg D</th><th>Best</th></tr>` :
        `<tr><th class="text-center">Rank</th><th>Player</th><th class="text-center bg-white/5">PQS</th><th>Kills</th><th>KDR</th><th>Wins</th><th>GP</th></tr>`;
    
    // 1. Calculate TRUE Global Rankings first
    const fullRanked = [...masterData].filter(p => !p.rankId?.toString().includes('?') || p.gp >= 5)
                                     .sort((a,b) => b[activeTab] - a[activeTab]);

    // Attach true global rank to each player object
    fullRanked.forEach((p, index) => { p.globalRank = index + 1; });

    // 2. Filter based on Search Query
    const filteredRanked = fullRanked.filter(p => p.name.toLowerCase().includes(searchQuery));
    const unranked = masterData.filter(p => p.rankId?.toString().includes('?') && p.gp < 5)
                               .filter(p => p.name.toLowerCase().includes(searchQuery));

    if (filteredRanked.length === 0 && unranked.length === 0 && searchQuery !== '') {
        body.innerHTML = `<tr><td colspan="12" class="text-center py-20 text-gray-500 italic uppercase tracking-widest">No matching players found</td></tr>`;
        return;
    }

    // 3. Render using the stored .globalRank
    body.innerHTML = filteredRanked.map(p => generateRowHTML(p, p.globalRank)).join('') + 
                     `<tr class="bg-white/5"><td colspan="12" class="text-center py-4 text-[10px] font-black tracking-[0.5em] text-white/40">UNRANKED PLACEMENTS</td></tr>` +
                     unranked.map(p => generateRowHTML(p, '?')).join('');
}

function generateRowHTML(p, rank) {
    const glow = (val, target, isBest=false) => {
        const num = typeof val === 'string' ? parseFloat(val.replace('%','')) : val;
        return (num > 0 && num === target) ? (isBest ? 'best-glow' : 'stat-glow') : '';
    };
    
    // Decorations only apply if the TRUE rank is 1, 2, or 3
    const icon = rank === 1 ? '<span class="rank-crown">üëë</span>' : 
                 rank === 2 ? '<span class="rank-medal">ü•à</span>' : 
                 rank === 3 ? '<span class="rank-medal">ü•â</span>' : 
                 rank === '?' ? '‚ùì' : `#${rank}`;
                 
    const goat = rank === 1 ? '<span class="text-[10px] bg-[#ff4655] text-white px-2 py-1 rounded ml-3 font-black italic shadow-lg">GOAT</span>' : '';

    if (activeTab === 'kd') {
        return `<tr class="${rank === 1 ? 'gold-row' : ''}">
            <td class="rank-cell font-black italic text-gray-400">${icon}</td>
            <td class="text-2xl font-black uppercase tracking-tighter">${p.name}${goat}</td>
            <td class="${glow(p.kills, topStats.kills)}">${p.kills}</td>
            <td class="${glow(p.deaths, topStats.deaths)}">${p.deaths}</td>
            <td class="text-5xl font-black italic text-center ${p.kd >= 1 ? 'text-green-500' : 'text-red-500'} ${glow(p.kd, topStats.kd)}">${p.kd.toFixed(3)}</td>
            <td class="text-green-500 font-bold ${glow(p.wins, topStats.wins)}">${p.wins}</td>
            <td class="text-red-500 font-bold ${glow(p.losses, topStats.losses)}">${p.losses}</td>
            <td class="font-bold ${glow(p.wr, topStats.wr)}">${p.wr}</td>
            <td class="font-mono ${glow(p.gp, topStats.gp)}">${p.gp}</td>
            <td class="${glow(p.avgK, topStats.avgK)}">${p.avgK}</td>
            <td class="${glow(p.avgD, topStats.avgD)}">${p.avgD}</td>
            <td class="italic font-black text-xl ${glow(p.highestK, topStats.highestK, true)}">${p.highestK}</td>
        </tr>`;
    } else {
        return `<tr class="${rank === 1 ? 'gold-row' : ''}">
            <td class="rank-cell font-black italic text-gray-400">${icon}</td>
            <td class="text-2xl font-black uppercase tracking-tighter">${p.name}${goat}</td>
            <td class="text-6xl font-black text-[#ff4655] text-center bg-white/5 ${glow(p.pqs, topStats.pqs)}">${p.pqs.toFixed(3)}</td>
            <td>${p.kills}</td>
            <td class="font-black italic text-xl">${p.kd.toFixed(3)}</td>
            <td class="text-green-500 font-bold">${p.wins}</td>
            <td class="font-mono">${p.gp}</td>
        </tr>`;
    }
}

function hideLoader() {
    document.getElementById('loading-screen').style.opacity = '0';
    setTimeout(() => {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('main-content').style.opacity = '1';
    }, 500);
}
init(); setInterval(init, 30000);
</script>
</body>
</html>
