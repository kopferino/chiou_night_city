<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant Customs Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { background-color: #0a0a0c; color: #ffffff; font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        .accent { color: #ff4655; }
        .loader { border-top-color: #ff4655; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto">
        <header class="mb-10 text-center md:text-left">
            <h1 class="text-4xl font-extrabold italic uppercase tracking-tighter">Customs <span class="accent text-6xl block md:inline">Leaderboard</span></h1>
            <p id="status-text" class="text-gray-500 font-mono text-xs mt-2 italic">INITIALIZING CONNECTION...</p>
        </header>

        <div id="main-content" class="hidden">
            <section class="mb-16">
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em] mb-4">Overall Standings</h2>
                <div class="overflow-x-auto glass">
                    <table class="w-full text-left">
                        <thead class="bg-white/5 text-gray-400 text-[10px] uppercase font-bold">
                            <tr>
                                <th class="p-4">Rank</th>
                                <th class="p-4">Player</th>
                                <th class="p-4">Matches</th>
                                <th class="p-4">Avg K/D</th>
                                <th class="p-4">Avg Rating</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
            </section>

            <section>
                <h2 class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em] mb-4">Recent Match Feed</h2>
                <div id="match-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>
        </div>

        <div id="loading-spinner" class="flex flex-col items-center justify-center py-40">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-800 h-12 w-12 mb-4"></div>
            <p class="text-gray-500 animate-pulse">Fetching Spreadsheet Data...</p>
        </div>
    </div>

<script>
    // Using a reliable CORS proxy
    const RAW_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4nTO5eB8-EVq9RmGZNz-5gkCjY_lZQSFnq5N7Okne8CNgH7z1hnEj9OqoL_tk3C2kxj-zwIfQVrUD/pub?output=csv';
    const PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(RAW_URL);

    async function init() {
        Papa.parse(PROXY_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            // THIS IS THE FIX: It cleans the headers as they come in
            transformHeader: (header) => header.trim().toLowerCase().replace(/[^a-z0-9]/g, ''), 
            complete: (results) => {
                if (results.data && results.data.length > 0) {
                    renderData(results.data);
                } else {
                    document.getElementById('status-text').innerText = "ERROR: SHEET IS EMPTY";
                }
            }
        });
    }

    function renderData(data) {
        document.getElementById('loading-spinner').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('status-text').innerText = "LIVE // SYNCED";

        const playerStats = {};
        const matchContainer = document.getElementById('match-feed');
        const lbBody = document.getElementById('leaderboard-body');
        
        matchContainer.innerHTML = '';
        lbBody.innerHTML = '';

        data.forEach(m => {
            // Because we cleaned the headers, "Date" becomes "date", "K/D/A" becomes "kda"
            const name = m.player || "Unknown";
            const date = m.date || "N/A";
            const k = parseInt(m.k) || 0;
            const d = parseInt(m.d) || 0;
            const a = parseInt(m.a) || 0;
            const rating = parseFloat(m.rating) || 0;

            if (!playerStats[name]) {
                playerStats[name] = { name, kills: 0, deaths: 0, rating: 0, count: 0 };
            }
            playerStats[name].kills += k;
            playerStats[name].deaths += d;
            playerStats[name].rating += rating;
            playerStats[name].count++;

            const kd = (k / (d || 1)).toFixed(2);

            matchContainer.innerHTML += `
                <div class="glass p-5 hover:border-[#ff4655] transition-all">
                    <div class="flex justify-between items-center mb-3">
                         <span class="text-[10px] text-gray-500 font-bold uppercase">${date}</span>
                         <span class="text-[10px] accent font-bold uppercase tracking-widest">${m.agent || 'Agent'}</span>
                    </div>
                    <h3 class="text-xl font-bold italic uppercase tracking-tighter">${name}</h3>
                    <p class="text-[10px] text-gray-400 mb-4">${m.map || 'Map'} • ${m.score || '0-0'}</p>
                    <div class="flex justify-between border-t border-white/5 pt-3 font-mono text-sm">
                        <span class="text-gray-400">KDA: <span class="text-white">${k}/${d}/${a}</span></span>
                        <span class="accent font-bold">★ ${rating}</span>
                    </div>
                </div>
            `;
        });

        const sortedPlayers = Object.values(playerStats).sort((a, b) => (b.rating/b.count) - (a.rating/a.count));
        
        lbBody.innerHTML = sortedPlayers.map((p, i) => `
            <tr class="border-t border-white/5 hover:bg-white/5 transition">
                <td class="p-4 font-bold text-gray-500">#${i + 1}</td>
                <td class="p-4 font-bold uppercase tracking-tight">${p.name}</td>
                <td class="p-4 text-gray-400">${p.count}</td>
                <td class="p-4 font-mono">${(p.kills / (p.deaths || 1)).toFixed(2)}</td>
                <td class="p-4 accent font-black text-lg italic">${(p.rating / p.count).toFixed(2)}</td>
            </tr>
        `).join('');
    }

    init();
    setInterval(init, 60000);
</script>